Музыкальный дверной звонок

*Введение
Когда возникла необходимость установить дверной звонок было два варианта:
купить готовый или сделать самому.
У готовыйх звонков был  ряд недостатков:
встроеные мелодии не отличаются качеством и разнообразием
нет регулятора громкости.

Но зато есть готовый корпус и в некоторых моделях радиокнопка.

Поэтому за основу я взял дешевый китайский звонок с радиокнопкой и поставил в него
свой синтезатор мелодии с регулированием громкости и блокированием включения.

В качестве мелодии можно загрузить большинство midi файлов.
Найти популярную мелодию в формате midi не представляет большой сложности. 
Чтобы сконвертировать midi в формат, пригодный для прошивки в архиве проекта
есть программа Continy45 (автор Dmitry Dubrovenko http://www.dubrovenko.ru)

За основу звукогенератора взята музыкальная шкатулка
http://elm-chan.org/works/mxb/report.html

Образец звучания.
http://elm-chan.org/works/mxb/mg.mpg

Данная прошивка может воспроизводить одновременно 6 каналов.
 Звучание для дверного звонка, я считаю, очень неплохое. По крайней мере гораздо лучше, чем в магазинных звонках.

*Особенности звонка

- Очень простая схема.
- Большое количество доступных мелодий.
- Гибкая настройка реимов работы

Алгоритм работы музыкальной шкатулки был слегка переработан:
Включение мелодии с помощью отдельной кнопки
Можно заблокировать воспроизведение мелодии с помощью специального входа.
Индикация блокировки мелодии на одном из выходов.

Для увеличения громкости добавлен простой усилитель с регулятором громкости.

В качестве корпуса был звонок с  питанием от батареек, поэтому батарейный отсек послужил отличным
местом для установки новой платы.

В качесте источника питания был пременен слегка модернизированый б/п для зарядки сотового
телефона. В принципе подойдет любой источник питания от 3 до 5В.

Микросхема звукогенератора была выпаяна, сигнал от кнопки заводится на новую плату.

Для индикации работы применяются два светодиода: зеленый - индикатор питания,  красный - блокировка звонка.
К звонку можно подключить геркон, устанавливаемый на дверь. 
На дверь устанавливается геркон и при открытии двери воспроизведение
мелодии прекращается.
На корпусе звонка есть переключатель для полной блокировки включения.

*Принципиальная схема

Схема достаточно простая. Если не нужна вся функциональность, то схему можно еще упростить.
Если не нужно автоматическое прерывание мелодии при откртой двери, то геркон можно не ставить, но тогда лучше
использовать более короткую мелодию. 
Кнопка SA1 - полной блокировки звонка можно тоже не ставить, но все-таки иногда удобно полностью отключить
звук звонка.

Если нет радиокнопки, то выход XS3 тоже не нужен.

Усилитель звука сделан очень примитивным, на одном транзисторе, но для звонка этого достаточно.
переменный резистор, регулирующий, громкость, можно сделать как подстроечным, оставив его внутри корпуса, 
так и вынести наружу корпуса, чтобы регулировать громкость по необходимости.
Если нет регилуровки громкости, то его вообще можно не ставить, соединив выход контроллера с резистором R2.

Резистор R2 регулирует
максимальную громкость, поэтому его номинал можно варировать примерно от 2 до 5кОм.

Громкость сильно зависит от самого динамика. Я проверял на двух похожих динамиках 0,25Вт, 8Ом. Если на одном
мелодию было еле слышно, то второй играл достаточно громко.

Если надо включать звонок низким уровнем, то резистор R? не нужен, но нужна небольшая доработка прошивки (см. ниже).

*Печатная плата

Сделана под размер батарейного отсека. Имеет несколько выход для подключения питания радиомодуля.

*Прошивка

Было внесено немного изменений в оригинальную прошивку, мои изменения прокомментироаны на русском языке.

Если нет радиокнопки, то вход 0 проще кнопкой замыкать на минус, тогда не нужен резистор, но прошивку придется переделать.
Как это сделать написано в коде прошивки.

В моем  варианте с радиокнопкой воспроизведение начинается, когда появляется высокий уровень на входе 0.

Для правильной работы прошивки необходимо прошить фьюзы:

-U lfuse:w:0xd1:m -U hfuse:w:0xdd:m -U efuse:w:0xff:m 

Для сборки и прошивки программы в проекте есть Makefile


*Редактирование мелодии.
Одинаковые мелодии, взятые из разных источников могут звучать немного по разному, поэтому лучше скачать несколько
вариантов мелодий, и сделать несколько вариантов прошивок, из которых выбрать наиболее приятно звучащий
вариант.

Можно предварительно отредактировать мелодию в midi, редакторе. Но это не так просто если не знаком
с таким родом программ. Зачастую проще сковертировать мелодию в формат прошивки, а в файле с мелодией
удалить часть мелодии. Этот метод не очень удобный но самый простой, если надо сократить длину мелодии.
Если сокращаете мелодию вручную, то надо смотреть, чтобы пара чисел перед EoS|en были близки по значению
к предыдущей ноте.
Например мелодия должна заканчиваться так:
119, 24, E4, H4|en, 0, 25, EoS|en

И необходимо следить, чтобы не было такого предупреждения:
Warning : A .DB segment with an odd number of bytes is detected. A zero byte is added.
Если оно появилось, значит мелодия отредатирована не верно, где-то появился лишний байт.

*Примечания по количеству мелодий:
Данная прошивка подразумевает воспроизведение одной мелодии.
Мне этого достаточно, поэтому я не стал усложнять прошивку.

Но несложно доработать прошивку таким образом, чтобы она воспроизводила несколько мелодий.
В Attiny45 можно записать 2-3 короткие мелодии. Если надо больше мелодий, можно применить
Attiny85 с 8кб флеш памяти. 




